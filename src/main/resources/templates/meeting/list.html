<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head th:include="include :: header"></head>
<body class="hold-transition skin-blue sidebar-mini">

<div class="modal fade" id="modal-create">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">创建会议</h4>
      </div>
      <div class="modal-body">
        <form id="meetingForm" class="form-horizontal" role="form">
          <div class="form-group">
            <label for="title" class="col-sm-2 control-label no-padding-right">主题</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="title">
            </div>
          </div>
          <div class="form-group">
            <label for="meetingDate" class="col-sm-2 control-label no-padding-right">会议时间</label>
            <div class="col-sm-10">
              <input type="text" class="form-control datepicker" name="date" readonly>
            </div>
          </div>
          <div class="form-group">
            <label for="address" class="col-sm-2 control-label no-padding-right">会议地点</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="address" placeholder="请输入人员名称">
            </div>
          </div>
          <div class="form-group">
            <label for="personnel" class="col-sm-2 control-label no-padding-right">与会人员</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="personnel" placeholder="请输入人员名称">
            </div>
          </div>
          <div class="form-group">
            <label for="content" class="col-sm-2 control-label no-padding-right">会议内容</label>
            <div class="col-sm-10">
              <textarea class="form-control" name="content" rows="10"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" id="btn-commit">确定</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<div class="modal fade" id="modal-update">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">创建会议</h4>
      </div>
      <div class="modal-body">
        <form id="meetingUpdateForm" class="form-horizontal" role="form">
          <input type="hidden" class="form-control" id="id" name="id">
          <div class="form-group">
            <label for="title" class="col-sm-2 control-label no-padding-right">主题</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="title" name="title">
            </div>
          </div>
          <div class="form-group">
            <label for="meetingDate" class="col-sm-2 control-label no-padding-right">会议时间</label>
            <div class="col-sm-10">
              <input type="text" class="form-control datepicker" id="meetingDate" name="date" readonly>
            </div>
          </div>
          <div class="form-group">
            <label for="address" class="col-sm-2 control-label no-padding-right">会议地点</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" name="address" id="address" placeholder="请输入人员名称">
            </div>
          </div>
          <div class="form-group">
            <label for="personnel" class="col-sm-2 control-label no-padding-right">与会人员</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="personnel" name="personnel" placeholder="请输入人员名称">
            </div>
          </div>
          <div class="form-group">
            <label for="content" class="col-sm-2 control-label no-padding-right">会议内容</label>
            <div class="col-sm-10">
              <textarea class="form-control" id="content" name="content" rows="10"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" id="btn-update">修改</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- Content Header (Page header) -->
<section class="content-header">
  <h1>
    公司战略纲领
  </h1>
</section>
<!-- Main content -->
<section class="content">

  <div class="row">
    <div class="col-xs-12">
      <div class="box">
        <div class="box-header">

          <div class="row">
            <div class="form-inline">
              <div class="form-group" style="margin-right: 10px;">
                <label>主题</label>
                <input type="text" id="topic" name="topic" class="form-control" placeholder="请输入会议主题">
              </div>
              <div class="form-group" style="margin-right: 10px;">
                <label>时间</label>
                <input type="text" class="form-control datepicker" id="startTime" readonly="readonly"/>
                <span>至</span>
                <input type="text" class="form-control datepicker" id="endTime" readonly="readonly"/>
              </div>
              <button class="btn btn-default" id="btn_search">搜索</button>
              <a shiro:hasPermission="meeting:create" class="btn btn-info pull-right" id="btn-meeting-create">添加</a>
            </div>
          </div>

        </div>
        <!-- /.box-header -->
        <div class="box-body">

          <table id="MeetingDataTables" class="table table-bordered" width="100%">
            <thead>
            <tr>
              <th>序号</th>
              <th>主题</th>
              <th>与会人员</th>
              <th>地点</th>
              <th>时间</th>
              <th>操作</th>
            </tr>
            </thead>
          </table>

        </div>
        <!-- /.box-body -->
      </div>
      <!-- /.box -->
    </div>
    <!-- /.col -->
  </div>
  <!-- /.row -->
</section>
<!-- /.content -->
<div th:include="include :: footer"></div>
<!-- page script -->
<script th:inline="javascript">

  var meetingTable;

  /** 刷新列表 */
  function reloadTable() {
    meetingTable.destroy();
    getMeetingList();
  }

  /** 加载列表 */
  function getMeetingList() {
    meetingTable = $('#MeetingDataTables').DataTable({
      fixedHeader: true,
      scrollX: false,
      "info": false,
      "ordering": false,
      "autoWidth": true,
      "lengthChange": false,  //每页显示的记录数
      "pageLength": 300,
      // "dom": "<'row'<'col-sm-6'><'col-sm-6'p>>t<'row'<'col-sm-6'B><'col-sm-6'p>>",
      // "dom": "<'row'<'col-sm-6'><'col-sm-6'p>>t<'row'<'col-sm-6'><'col-sm-6'p>>",
      "searching": false,//禁用搜索
      "processing": true,
      "serverSide": true,
      "dom": "Tft<'row DTTTFooter'<'col-sm-6'li><'col-sm-6'p>>",
      "ajax": {
        url: /*[[@{/meeting/list}]]*/,
        type: "POST",
        data: {
          "topic": $("#topic").val(),
          "startTime": $("#startTime").val(),
          "endTime": $("#endTime").val()
        },
        dataSrc: function (json) {
          if (json.status === 200) {
            json.draw = json.content.draw;
            json.recordsTotal = json.content.recordsTotal;
            json.recordsFiltered = json.content.recordsFiltered;
            json.data = json.content.data;
          }
          return json.data;
        }
      },
      "columns": [
        {
          "data": null,
          "width": "40px",
          render: function (data, type, row, meta) {
            return meta.row + 1;
          }
        },
        {
          "data": "title"/*,
          render: function (data, type, row, meta) {
            return '<a href="/meeting/' + row.id + '">' + data + '</a>';
          }*/
          // "width": "10%"
        },
        {
          "data": "personnel"
          // "width": "10%"
        },
        {
          "data": "address"
          // "width": "10%"
        },
        {
          "data": "date",
          "width": "100px"
        },
        {
          "data": "id",
          "width": "150px",
          render: function (data, type, row, meta) {
            if (row.status === 1) {
              return '<a style="margin-left: 5px" class="btn btn-info btn-xs" href="/meeting/'+data+'" >查看</a>' +
              '<a style="margin-left: 5px" class="btn btn-warning btn-xs meeting-return" href="javascript:void(0);" onclick="returnMeeting(' + data + ')">退回</a>'
                  + '<a style="margin-left: 5px" class="btn btn-danger btn-xs meeting-del" href="javascript:void(0);" onclick="delMeeting(' + data + ')">删除</a>';
            } else {
              return '<a style="margin-left: 5px" class="btn btn-info btn-xs" href="/meeting/'+data+'" >查看</a>' +
                  '<a style="margin-left: 5px" class="btn btn-warning btn-xs meeting-update" href="javascript:void(0);" onclick="updateMeeting(' + data + ',\''+row.title+'\',\''+row.content+'\',\''+row.date+'\',\''+row.address+'\',\''+row.personnel+'\')">修改</a>'
                  + '<a style="margin-left: 5px" class="btn btn-danger btn-xs meeting-del" href="javascript:void(0);" onclick="delMeeting(' + data + ')">删除</a>';
            }
          }
        }
      ],
      "language": { // 国际化配置
        "sProcessing": "正在获取数据，请稍后...",
        "sLengthMenu": "显示 _MENU_ 条",
        "sZeroRecords": "没有找到数据",
        "info": "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
        "infoEmpty": "记录数为0",
        "infoFiltered": "(全部记录数 _MAX_ 条)",
        "paginate": {
          "first": "第一页",
          "previous": "上一页",
          "next": "下一页",
          "last": "最后一页"
        }
      }
    });
  }

  /** 创建会议 */
  function commitMeeting() {
    $.ajax({
      url: /*[[@{/meeting/create}]]*/,
      type: "POST",
      data: $("#meetingForm").serialize(),
      success: function (result) {
        if (result.status === 200) {
          toastr.success("添加成功！");
          //重新加载数据
          meetingTable.ajax.reload();
          $("#meetingForm")[0].reset();
          $('#modal-create').modal('hide');
        } else {
          toastr.error("添加失败！");
        }
      },
      error: function () {
        toastr.success("添加失败！");
      }
    });
  }

  /** 删除会议 */
  function delMeeting(id) {
    bootbox.setLocale("zh_CN");
    bootbox.confirm("确定删除这个会议吗?", function (result) {
      if (result) {
        $.ajax({
          url: /*[[@{/meeting/del}]]*/,
          type: "POST",
          data: {"id": id},
          success: function (result) {
            if (result.status === 200) {
              toastr.success("操作成功！");
              //重新加载数据
              meetingTable.ajax.reload();
            } else {
              toastr.error("操作失败！");
            }
          },
          error: function () {
            toastr.error("系统错误，操作失败！");
          }
        });
      }
    });
    event.stopPropagation();
  }

  /** 退回会议 */
  function returnMeeting(id) {
    bootbox.setLocale("zh_CN");
    bootbox.confirm("确定退回这个会议吗?", function (result) {
      if (result) {
        $.ajax({
          url: /*[[@{/meeting/return}]]*/,
          type: "POST",
          data: {"id": id},
          success: function (result) {
            if (result.status === 200) {
              toastr.success("操作成功！");
              //重新加载数据
              meetingTable.ajax.reload();
            } else {
              toastr.error("操作失败！");
            }
          },
          error: function () {
            toastr.error("系统错误，操作失败！");
          }
        });
      }
    });
    event.stopPropagation();
  }

  /** 显示修改模态框 */
  function updateMeeting(id,title,content,date,address,personnel) {
    $("#id").val(id);
    $("#title").val(title);
    $("#content").val(toTextarea(content));
    $("#meetingDate").val(date);
    $("#address").val(address);
    $("#personnel").val(personnel);
    $("#modal-update").modal("show");
  }

  /** 修改会议 */
  function update() {
    $.ajax({
      url: /*[[@{/meeting/update}]]*/,
      type: "POST",
      data: $("#meetingUpdateForm").serialize(),
      success: function (result) {
        if (result.status === 200) {
          toastr.success("修改成功！");
          //重新加载数据
          meetingTable.ajax.reload();
          $("#meetingUpdateForm")[0].reset();
          $('#modal-update').modal('hide');
        } else {
          toastr.error("修改失败！");
        }
      },
      error: function () {
        toastr.success("修改失败！");
      }
    });
  }

  /** 搜索按钮事件 */
  function searchEvent() {
    $("#btn_search").click(function () {
      reloadTable();
    });
  }

  /** 设置权限 */
  function setPermission() {
    meetingTable.on('draw.dt', function () {
      var permissions = [[${session.permissions}]];
      if ($.inArray('meeting:return', permissions) === -1) {
        $(".meeting-return").hide();
      }
      if ($.inArray('meeting:del', permissions) === -1) {
        $(".meeting-del").hide();
      }
      if ($.inArray('meeting:update', permissions) === -1) {
        $(".meeting-update").hide();
      }
    });
  }

  function toTextarea(str){
    var reg=new RegExp("<br>","g");
    var regSpace=new RegExp("&ensp;","g");

    str = str.replace(reg,"\n");
    str = str.replace(regSpace," ");

    return str;
  }

  function textareaTo(str){
    var reg=new RegExp("\n","g");
    var regSpace=new RegExp(" ","g");

    str = str.replace(reg,"<br>");
    str = str.replace(regSpace,"&nbsp;");

    return str;
  }

  $(function () {

    getMeetingList();

    searchEvent();

    setPermission();

    /** 显示添加模态框 */
    $("#btn-meeting-create").click(function () {
      $('#modal-create').modal('show');
    });

    /** 添加会议提交按钮 */
    $("#btn-commit").click(function () {
      commitMeeting();
    });

    /** 修改会议提交按钮 */
    $("#btn-update").click(function () {
      update();
    });

    // 日期控件配置
    $('.datepicker').datepicker({
      format: 'yyyy-mm-dd',
      language: 'zh-cn',
      autoclose: true,
      clearBtn: true
    });


    var topDistance = 500;
    var showDistance = 1;
    var thisTop = $(window).scrollTop() + topDistance;
    // $('#goToTop').css('top' ,thisTop);
    if ($(window).scrollTop() < showDistance) {
      $('#goToTop').hide();
    }
    $(window).scroll(function () {
      thisTop = $(this).scrollTop() + topDistance;        //获取当前window向上滚动的距离
      if ($(this).scrollTop() > showDistance) {
        $('#goToTop').fadeIn();
      } else {
        $('#goToTop').fadeOut();
      }
    });

  });

</script>
</body>
</html>
