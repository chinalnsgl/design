<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" th:href="@{/bootstrap/dist/css/bootstrap.min.css}">
  <!-- Font Awesome -->
  <link rel="stylesheet" th:href="@{/font-awesome/css/font-awesome.min.css}">
  <!-- Ionicons -->
  <link rel="stylesheet" th:href="@{/Ionicons/css/ionicons.min.css}">
  <!-- Theme style -->
  <link rel="stylesheet" th:href="@{/css/AdminLTE.min.css}">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" th:href="@{/css/skins/_all-skins.min.css}">
  <link rel="stylesheet" th:href="@{/css/toastr.min.css}">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

</head>
<body class="hold-transition skin-blue sidebar-mini">

<div class="modal fade" id="modal-info">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">编辑任务进度</h4>
      </div>
      <div class="modal-body">

        <form id="taskForm" class="form-horizontal" role="form">
          <input type="hidden" name="id" id="id">
          <input type="hidden" name="status" id="status">

          <div class="form-group">
            <label for="principal" class="col-sm-2 control-label no-padding-right">项目</label>
            <div class="col-sm-10">
              <span id="projectName"></span>
            </div>
          </div>
          <div class="form-group">
            <label for="principal" class="col-sm-2 control-label no-padding-right">任务</label>
            <div class="col-sm-10">
              <span id="stepName"></span>
            </div>
          </div>
          <div class="form-group">
            <label for="principal" class="col-sm-2 control-label no-padding-right">负责人</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="principal" name="principal" placeholder="请输入负责人" >
            </div>
          </div>
          <div class="form-group">
            <label for="comment" class="col-sm-2 control-label no-padding-right">备注</label>
            <div class="col-sm-10">
              <textarea class="form-control" placeholder="请输入备注" rows="3" id="comment" name="comment"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" id="btn-colse" data-dismiss="modal">确定</button>
        <button type="button" class="btn btn-info" id="btn-commit">确定</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>

<section class="content-header">
  <h1>
    单项目看板
  </h1>
</section>
<!-- Main content -->
<section class="content">
  <div class="row">
    <div class="col-md-12">

      <div class="box">
        <!-- /.box-header -->
        <div class="box-body">
          <ul id="haveProject"  class="timeline">
            <!-- timeline time label -->
            <li class="time-label" th:each="task:${project.produceTasks}">
              <span class="bg-red" th:text="${task.produceName}">下达任务单</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="sendEndTime" th:text="${#dates.format(task.endTime,'yyyy-MM-dd')}"></span></span>
                <h3 class="timeline-header">开始时间： <span id="sendStartTime" th:text="${#dates.format(task.startTime,'yyyy-MM-dd')}"></span></h3>
              </div>
            </li>
            <!-- /.timeline-label -->
            <!-- timeline time label -->
            <!--<li class="time-label">
              <span class="bg-red">签订技术协议</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="signEndTime"></span></span>
                <h3 class="timeline-header">开始时间： <span id="signStartTime"></span></h3>
              </div>
            </li>
            &lt;!&ndash; /.timeline-label &ndash;&gt;

            <li id="preInput" class="time-label">
              <span class="bg-red">生产制造</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="produceEndTime"></span></span>
                <h3 class="timeline-header">生产制造</h3>
                <div class="timeline-body">
                  开始时间： <span id="produceStartTime"></span><br>
                </div>
              </div>
            </li>
            <li class="time-label">
              <span class="bg-red">安装</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="installEndTime"></span></span>
                <h3 class="timeline-header">开始时间： <span id="installStartTime"></span></h3>
              </div>
            </li>
            <li class="time-label">
              <span class="bg-red">调试</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="debugEndTime"></span></span>
                <h3 class="timeline-header">开始时间： <span id="debugStartTime"></span></h3>
              </div>
            </li>
            <li class="time-label">
              <span class="bg-red">验收</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="acceptEndTime"></span></span>
                <h3 class="timeline-header">开始时间： <span id="acceptStartTime"></span></h3>
              </div>
            </li>
            <li class="time-label">
              <span class="bg-red">图纸存档</span>
              <div class="timeline-item">
                <span class="time"><i class="fa fa-clock-o"></i> <span id="archiveEndTime"></span></span>
                <h3 class="timeline-header">开始时间： <span id="archiveStartTime"></span></h3>
              </div>
            </li>-->
            <li>
              <i class="fa fa-clock-o bg-gray"></i>
            </li>
          </ul>

          <h1 id="noProject" style="display: none">无项目数据</h1>

        </div>

        <!-- /.box-body -->
      </div>
      <!-- The time line -->

    </div>
  </div>
</section>
<!-- /.content -->
<!-- jQuery 3 -->
<script th:src="@{/jquery/dist/jquery.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script th:src="@{/bootstrap/dist/js/bootstrap.min.js}"></script>
<!-- FastClick -->
<script th:src="@{/fastclick/lib/fastclick.js}"></script>
<!-- AdminLTE App -->
<script th:src="@{/js/adminlte.min.js}"></script>
<!-- AdminLTE for demo purposes -->
<script th:src="@{/js/demo.js}"></script>
<script th:src="@{/js/toastr.min.js}"></script>
<!-- page script -->
<script>

  var deptName = ["","机械设计","液压设计","电气设计","软件设计"];
  var deptNum = ["","一科","二科","三科","四科","五科","六科","七科"];
  var statusName = ["未开始","执行中","已完成"];

  function taskEdit() {
    $.ajax({
      url: "/project/editTask",
      type:"POST",
      data : $("#taskForm").serialize(),
      success: function(result){
        if (result.status === 200) {
          getProject();
          $("#modal-info").modal('hide');
          toastr.success("编辑成功！");
        }
      },
      error: function() {
        toastr.success("编辑失败！");
      }
    });

  }

  function getProject() {
    $.ajax({
      url: "/project/item",
      type:"POST",
      data : {
        "code": $("#codeQuery").val(),
        "name": $("#nameQuery").val()
      },
      success: function(result){
        if (result.status === 200) {
          if (result.content) {
            $("#haveProject").show();
            $("#noProject").hide();
            var mData = result.content;
            // 下任务
            if (mData.sendStartTime) {
              $("#sendStartTime").text(mData.sendStartTime);
            }else {
              $("#sendStartTime").text("未开始");
            }
            if (mData.sendEndTime) {
              $("#sendEndTime").text(mData.sendEndTime);
            } else {
              $("#sendEndTime").text("未完成");
            }
            // 签协议
            if (mData.signStartTime) {
              $("#signStartTime").text(mData.signStartTime);
            }else {
              $("#signStartTime").text("未开始");
            }
            if (mData.signEndTime) {
              $("#signEndTime").text(mData.signEndTime);
            } else {
              $("#signEndTime").text("未完成");
            }



            //生产
            if (mData.produceStartTime) {
              $("#produceStartTime").text(mData.produceStartTime);
            }else {
              $("#produceStartTime").text("未开始");
            }
            if (mData.produceEndTime) {
              $("#produceEndTime").text(mData.produceEndTime);
            } else {
              $("#produceEndTime").text("未完成");
            }
            // 安装
            if (mData.installStartTime) {
              $("#installStartTime").text(mData.installStartTime);
            }else {
              $("#installStartTime").text("未开始");
            }
            if (mData.installEndTime) {
              $("#installEndTime").text(mData.installEndTime);
            } else {
              $("#installEndTime").text("未完成");
            }
            // 调试
            if (mData.debugStartTime) {
              $("#debugStartTime").text(mData.debugStartTime);
            }else {
              $("#debugStartTime").text("未开始");
            }
            if (mData.debugEndTime) {
              $("#debugEndTime").text(mData.debugEndTime);
            } else {
              $("#debugEndTime").text("未完成");
            }
            //验收
            if (mData.acceptStartTime) {
              $("#acceptStartTime").text(mData.acceptStartTime);
            }else {
              $("#acceptStartTime").text("未开始");
            }
            if (mData.acceptEndTime) {
              $("#acceptEndTime").text(mData.acceptEndTime);
            } else {
              $("#acceptEndTime").text("未完成");
            }
            // 存档
            if (mData.archiveStartTime) {
              $("#archiveStartTime").text(mData.archiveStartTime);
            }else {
              $("#archiveStartTime").text("未开始");
            }
            if (mData.archiveEndTime) {
              $("#archiveEndTime").text(mData.archiveEndTime);
            } else {
              $("#archiveEndTime").text("未完成");
            }
            $("li.deptLi").remove();

            getTaskList(mData);
            /*$.each(mData.deptTasks,function (i,data) {
              var strTemp = '<i class="fa fa-envelope bg-blue"></i>';
              switch (data.departmentType ) {
                case 1: strTemp = '<i class="fa fa-envelope bg-blue"></i>';
                break;
                case 2: strTemp = '<i class="fa fa-envelope bg-yellow"></i>';
                break;
                case 3:strTemp = '<i class="fa fa-envelope bg-purple"></i>';
                break;
                case 4:strTemp = '<i class="fa fa-envelope bg-maroon"></i>';
                break;
              }

              $("#preInput").before('<li class="deptLi">' + strTemp +
                  '<div class="timeline-item"><span class="time">完成时间： <i class="fa fa-clock-o"></i> ' + (data.endTime ? data.endTime : '未完成')
                  + '</span>' +
                  '<h3 class="timeline-header">' + data.stepName + '</h3>' +
                  '<div class="timeline-body">' +
                  '任务项目： ' + data.stepName + '    ' +
                  '设计科室： ' + deptName[data.departmentType] + deptNum[data.departmentNum] +
                  '<br>开始时间： ' + (data.startTime ? data.startTime : '未开始') +
                  '     备注：' + (data.comment ? data.comment : '') +
                  '</div>' +
                  '<div class="timeline-footer">' +
                  '<a class="btn btn-primary btn-xs" onclick="edit('+data.id+',\''+mData.name+'\',\''+data.stepName+'\',\''+deptName[data.departmentType] + deptNum[data.departmentNum]+'\','+data.status+',\''+data.principal+'\',\''+data.comment+'\')">编辑</a>' +
                  '</div>' +
                  '</div>' +
                  '</li>');

            })*/

          } else {
            $("#haveProject").hide();
            $("#noProject").show();
          }
        }

      },
      error: function() {

      }
    });
  }

  function getTaskList(mData) {
    $.ajax({
      url: "/project/taskList",
      type:"POST",
      data : {"id":mData.id},
      success: function(result){
        if (result.status === 200) {
          $.each(result.content,function (i,data) {
            var strTemp = '<i class="fa fa-envelope bg-blue"></i>';
            switch (data.departmentType ) {
              case 1: strTemp = '<i class="fa fa-envelope bg-blue"></i>';
                break;
              case 2: strTemp = '<i class="fa fa-envelope bg-yellow"></i>';
                break;
              case 3:strTemp = '<i class="fa fa-envelope bg-purple"></i>';
                break;
              case 4:strTemp = '<i class="fa fa-envelope bg-maroon"></i>';
                break;
            }

            $("#preInput").before('<li class="deptLi">' + strTemp +
                '<div class="timeline-item"><span class="time">完成时间： <i class="fa fa-clock-o"></i> ' + (data.endTime ? data.endTime : '未完成')
                + '</span>' +
                '<h3 class="timeline-header">' + data.stepName + '</h3>' +
                '<div class="timeline-body">' +
                '任务项目： ' + data.stepName + '    ' +
                '设计科室： ' + deptName[data.departmentType] + deptNum[data.departmentNum] +
                '<br>开始时间： ' + (data.startTime ? data.startTime : '未开始')  +
                '     备注：' + (data.comment ? data.comment : '') + '<br><span>'+(data.endTime ? '已完成' : '未完成')+'</span>' +
                '</div>' +
                '<div class="timeline-footer">' +
                '<a class="btn btn-primary btn-xs" onclick="edit('+data.id+',\''+mData.name+'\',\''+data.stepName+'\',\''+deptName[data.departmentType] + deptNum[data.departmentNum]+'\','+data.status+',\''+data.principal+'\',\''+data.comment+'\')">编辑</a>' +
                '</div>' +
                '</div>' +
                '</li>');

          })
        }
      }
    });

  }

  function edit(id,projectName,stepName,deptName,status,principal,comment) {
    $("#id").val(id);
    $("#projectName").text(projectName);
    $("#stepName").text(deptName + "----" + stepName);
    if (status == 0) {
      $("#status").val(1);
      $("#btn-commit").text("开始");
      $("#btn-commit").show();
      $("#btn-colse").hide();
    } else if (status == 1) {
      $("#status").val(2);
      $("#btn-commit").text("完成");
      $("#btn-commit").show();
      $("#btn-colse").hide();
    } else {
      $("#status").val(3);
      $("#btn-commit").hide();
      $("#btn-colse").show();
    }
    $("#principal").val(principal!='null'?principal:'');
    $("#comment").val(comment!='null'?comment:'');
    $('#modal-info').modal('show');
  }

  $(function () {
    $("#btn-commit").click(function () {
      taskEdit();
    });
  })
</script>
</body>
</html>
