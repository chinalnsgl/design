<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="include :: header"></head>
<body class="hold-transition skin-blue sidebar-mini">

<div class="modal fade" id="modal-info">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">统计信息</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <label class="col-sm-4 no-padding-right">项目数量</label>
          <div class="col-sm-2 center-info" id="project_num"></div>
          <label  class="col-sm-4 no-padding-right">产品数量</label>
          <div class="col-sm-2 center-info" id="product_num"></div>
        </div>
        <div class="row">
          <label  class="col-sm-4 no-padding-right">已删除项目数量（未完成）</label>
          <div class="col-sm-2 center-info" id="project_del_uncomp_num"></div>
          <label  class="col-sm-4 no-padding-right">已删除项目产品数量</label>
          <div class="col-sm-2 center-info" id="product_del_uncomp_num"></div>
        </div>
        <div class="row">
          <label  class="col-sm-4 no-padding-right">已删除项目数量（完成）</label>
          <div class="col-sm-2 center-info" id="project_del_comp_num"></div>
          <label  class="col-sm-4 no-padding-right">已删除项目产品数量</label>
          <div class="col-sm-2 center-info" id="product_del_comp_num"></div>
        </div>
        <div class="row">
          <label  class="col-sm-4 no-padding-right">未完成数量</label>
          <div class="col-sm-2 center-info" id="project_dept_undone_num"></div>
          <label  class="col-sm-4 no-padding-right">未完成产品数量</label>
          <div class="col-sm-2 center-info" id="product_dept_undone_num"></div>
        </div>
        <div class="row">
          <label class="col-sm-4 no-padding-right">已完成数量</label>
          <div class="col-sm-2 center-info" id="project_dept_done_num"></div>
          <label  class="col-sm-4 no-padding-right">已完成产品数量</label>
          <div class="col-sm-2 center-info" id="product_dept_done_num"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info btn-close" data-dismiss="modal">确定</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        设计进度看板
        <small>设计进度看板</small>
      </h1>
    </section>
    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box">
            <div class="box-header">

              <div class="row">
                <div class="form-inline">
                  <div class="form-group" style="margin-right: 10px;">
                    <label>项目号</label>
                    <input type="text" id="codeQuery" name="code" class="form-control" placeholder="请输入项目号">
                  </div>
                  <div class="form-group" style="margin-right: 10px;">
                    <label>项目名称</label>
                    <input type="text" id="nameQuery" name="name" class="form-control" placeholder="请输入项目名称">
                  </div>
                  <div class="form-group" style="margin-right: 10px;">
                    <label>设计科室</label>
                    <select id="departmentQuery" name="departmentQuery" class="form-control select2" >
                      <option value="" selected="selected">请选择</option>
                      <option value="1,1">机械设计一科</option>
                      <option value="1,2">机械设计二科</option>
                      <option value="1,3">机械设计三科</option>
                      <option value="1,4">机械设计四科</option>
                      <option value="1,5">机械设计五科</option>
                      <option value="1,6">机械设计六科</option>
                      <option value="1,7">机械设计七科</option>
                      <option value="1,8">机械设计八科</option>
                      <option value="2,1">液压设计一科</option>
                      <option value="2,2">液压设计二科</option>
                      <option value="3,1">电气设计一科</option>
                      <option value="3,2">电气设计二科</option>
                      <option value="3,3">电气设计三科</option>
                      <option value="4,1">软件设计一科</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-right: 10px;">
                    <label>
                      设计状态
                    </label>
                    <select id="status" name="status" class="form-control select2" >
                      <option value="" selected="selected">全部</option>
                      <option value="1">未完成</option>
                      <option value="2">已完成</option>
                      <!--<option value="3">已取消</option>-->
                    </select>
                  </div>
                  <button class="btn btn-default" id="btn_search">搜索</button>
                  <!--<button class="btn btn-default" id="btn_collect" disabled>统计</button>-->
                </div>
              </div>

            </div>
            <!-- /.box-header -->
            <div class="box-body">

              <table id="projectDataTables" class="table table-bordered" width="100%">
                <thead>
                <tr>
                  <th>序号</th>
                  <th>项目名称</th>
                  <th>需方</th>
                  <th>安装地点</th>
                  <th>项目号</th>
                  <th>任务单号</th>
                  <th>数量</th>
                  <th>计划完成时间</th>
                  <th>科室</th>
                  <th>签技术协议</th>
                  <th>设计</th>
                  <th>条件相关</th>
                  <th>采购计划</th>
                  <th>下图纸</th>
                  <th>调试运行</th>
                  <th>备注</th>
                  <th>操作</th>
                </tr>
                </thead>
              </table>

            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </section>
    <div id="goToTop" th:style="|position:fixed; right:0px; bottom:10px; width:20px; height:75px; background-image: url(@{/img/gototop.gif}); cursor:pointer|"></div>
    <!-- /.content -->
    <div th:include="include :: footer"></div>
    <script th:inline="javascript">

      var projectTable, temp;
      var deptName = ["","机械设计","液压设计","电气设计","软件设计"];
      var deptNum = ["","一科","二科","三科","四科","五科","六科","七科","八科"];
      var statusName = ["未开始","执行中","已完成","已取消"];
      /** 刷新列表 */
      function reloadTable() {
        projectTable.destroy();
        getProjectList();
      }

      /** 加载列表 */
      function getProjectList() {

        projectTable = $('#projectDataTables').DataTable( {
          buttons: [
            {
              extend: 'excel',
              text: '导出Excel',
              className: 'btn btn-success pull-right',
              filename: '设计进度',
              exportOptions: {
                // 将打印 id 和 title 列
                columns: [ 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]
              }
            }
          ],
          fixedHeader: true,
          scrollX: false,
          "info": true,
          "ordering": false,
          "autoWidth": true,
          "lengthChange": false,  //每页显示的记录数
          "pageLength": 300,
          "dom": "<'row'<'col-sm-6'><'col-sm-6'p>>t<'row'<'col-sm-6'B><'col-sm-6'p>>",
          // "dom": "<'row'<'col-sm-6'><'col-sm-6'p>>t<'row'<'col-sm-6'><'col-sm-6'p>>",
          "searching":false,//禁用搜索
          "processing": true,
          "serverSide": true,
          "ajax": {
            url : "/project/dept/list",
            type : "POST",
            data : {
              "code": $("#codeQuery").val(),
              "name": $("#nameQuery").val(),
              departmentQuery : $("#departmentQuery").val(),
              "status" : $("#status").val()
            },
            dataSrc : function (json) {
              if (json.status === 200) {
                json.draw = json.content.draw;
                json.recordsTotal = json.content.recordsTotal;
                json.recordsFiltered = json.content.recordsFiltered;
                json.data = json.content.data;
              }
              return json.data;
            }
          },
          "columns": [
            { "data": "projectNo",
              "width": "8px"
            },
            { "data": "name",
              "width": "180px"
            },
            { "data": "demander",
              "width": "170px"
            },
            { "data": "address",
              "width": "100px"
            },
            { "data": "code",
              // "width": "5%",
            },
            { "data": "codeSpecial",
              // "width": "5%",
            },
            { "data": "num",
              // "width": "20%",
            },
            { "data": "planTime",
              "width": "100px"
            },
            { "data": "type",
              "width": "140px",
              render : function(data, type, row, meta) {
                return deptName[data] + deptNum[row.deptNum];
              }
            },
            { "data": "signStatus",
              "width": "70px",
              render : function(data, type, row, meta) {
                return '<span>' + statusName[data] + '</span>';
              }
            },
            { "data": "firstStep",
              "width": "70px",
              render : function(data, type, row, meta) {
                if(data > 2)
                  data = 3
                return statusName[data];
              }
            },
            { "data": "secondStep",
              "width": "70px",
              render : function(data, type, row, meta) {
                if(data > 2)
                  data = 3
                return statusName[data];
              }
            },
            { "data": "thirdStep",
              "width": "70px",
              render : function(data, type, row, meta) {
                if(data > 2)
                  data = 3
                return statusName[data];
              }
            },
            { "data": "fourthStep",
              "width": "70px",
              render : function(data, type, row, meta) {
                if(data > 2)
                  data = 3
                return statusName[data];
              }
            },
            { "data": "debugStatus",
              "width": "70px",
              render : function(data, type, row, meta) {
                return '<span>' + statusName[data] + '</span>';
              }
            },
            { "data": "comment",
              "width": "100px"
            },
            { "data": "id",
              "width": "70px",
              render : function(data, type, row, meta) {
                return '<a style="margin-right: 5px" class="btn btn-info btn-xs dept-view" href="/project/single/' + data + '">查看</a>';
              }
            }
          ],
          "createdRow": function ( row, data, index ) {
            if($("#departmentQuery").find("option:selected").text() == (deptName[data.type] + deptNum[data.deptNum]) && data.projectStatus !== 0 && data.projectStatus !== 3){
              $('td', row).eq(8).css("background", '#e0e0e0');
              $('td', row).eq(10).css("background", '#e0e0e0');
              $('td', row).eq(11).css("background", '#e0e0e0');
              $('td', row).eq(12).css("background", '#e0e0e0');
              $('td', row).eq(13).css("background", '#e0e0e0');
            }

            if(data.signStatus === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(9).css("background", '#f39c12');
            if(data.signStatus === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
            // $('td', row).eq(8).addClass("success-status");
              $('td', row).eq(9).css("background", '#00a65a');

            if(data.firstStep === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(10).css("background", '#f39c12');
            if(data.firstStep === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(10).css("background", '#00a65a');
            if(data.firstStep >= 100 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(10).css("background", 'red');

            if(data.secondStep === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(11).css("background", '#f39c12');
            if(data.secondStep === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(11).css("background", '#00a65a');
            if(data.secondStep >= 100 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(11).css("background", 'red');

            if(data.thirdStep === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(12).css("background", '#f39c12');
            if(data.thirdStep === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(12).css("background", '#00a65a');
            if(data.thirdStep >= 100 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(12).css("background", 'red');

            if(data.fourthStep === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(13).css("background", '#f39c12');
            if(data.fourthStep === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(13).css("background", '#00a65a');
            if(data.fourthStep >= 100 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(13).css("background", 'red');

            if(data.debugStatus === 1 && data.projectStatus !== 0 && data.projectStatus !== 3)
              $('td', row).eq(14).css("background", '#f39c12');
            if(data.debugStatus === 2 && data.projectStatus !== 0 && data.projectStatus !== 3)
            // $('td', row).eq(8).addClass("success-status");
              $('td', row).eq(14).css("background", '#00a65a');

            if (data.projectStatus === 0) {
              $(row).css('background', '#FF0000');
            }
            if (data.projectStatus === 3) {
              $(row).css('background', '#f39c12');
            }

            if (temp!=null && data.code === $('td', temp).eq(4).html()) {
              rowspan = $('td', temp).eq(4).attr("rowSpan");
              if (rowspan === undefined) {
                $('td', temp).eq(4).attr("rowSpan",1);
                rowspan = $('td', temp).eq(4).attr("rowSpan");
              }
              rowspan = Number(rowspan)+1;
              merge(temp, row, rowspan, [0,1, 2, 3, 4, 5, 6, 7, 9, 14, 15, 16]);
            } else {
              temp = row;
              $('td', row).css("border-top", '1px solid black');
            }
          },
          "language" : { // 国际化配置
            "sProcessing" : "正在获取数据，请稍后...",
            "sLengthMenu" : "显示 _MENU_ 条",
            "sZeroRecords" : "没有找到数据",
            "info" : "从 _START_ 到  _END_ 条记录 总记录数为 _TOTAL_ 条",
            "infoEmpty" : "记录数为0",
            "infoFiltered" : "(全部记录数 _MAX_ 条)",
            "paginate" : {
              "first" : "第一页",
              "previous" : "上一页",
              "next" : "下一页",
              "last" : "最后一页"
            }
          }
        });
      }

      function merge(tr,row,n,arr) {

        $.each(arr,function (i, v) {
          $('td', tr).eq(v).attr("rowSpan",n);
          $('td', row).eq(v).hide();
        })
      }

      /** 搜索按钮事件 */
      function searchEvent() {
        $("#btn_search").click(function () {
          temp = null;
          if (!projectTable) {
            getProjectList();
          } else {
            reloadTable();
          }
          // setPermission();
        });
      }

      /** 统计按钮事件 */
      function collectEvent() {
        $("#btn_collect").click(function () {
          $("#btn_search").trigger('click');
          $.ajax({
            url: "/project/dept/collect",
            type: "POST",
            data: {
              "code": $("#codeQuery").val(),
              "name": $("#nameQuery").val(),
              departmentQuery : $("#departmentQuery").val(),
              "status" : $("#status").val()
            },
            success: function (result) {
              if (result.status === 200) {
                var list = result.content;
                $("#project_num").text(list[0].projectNum);
                $("#product_num").text(list[0].productNum);
                $("#project_del_uncomp_num").text(list[1].projectNum);
                $("#product_del_uncomp_num").text(list[1].productNum);
                $("#project_del_comp_num").text(list[2].projectNum);
                $("#product_del_comp_num").text(list[2].productNum);
                $("#project_dept_undone_num").text(list[3].projectNum);
                $("#product_dept_undone_num").text(list[3].productNum);
                $("#project_dept_done_num").text(list[4].projectNum);
                $("#product_dept_done_num").text(list[4].productNum);

                $("#modal-info").modal('show');
              }
            },
            error: function () {
              toastr.success("服务器失败！");
            }
          });
        });
      }

      function setPermission() {
        projectTable.on( 'draw.dt', function () {
          var roles = [[${session.roles}]];
          var permissions = [[${session.permissions}]];
          if ($.inArray('dept:view', permissions) === -1) {
            $(".dept-view").hide();
          }
        } );
      }

      $(function () {

        getProjectList();

        searchEvent();



        $('#projectDataTables').on( 'page.dt', function () {
          temp = null;
        });

        $('.datepicker').datepicker({
          format: 'yyyy-mm-dd',
          language: 'zh-cn',
          autoclose: true,
          clearBtn: true
        });

        $("#departmentQuery").change(function () {
          if ($(this).val() != null && $(this).val() != "") {
            $("#btn_collect").attr("disabled", false);
          } else {
            $("#btn_collect").attr("disabled", true);
          }
        });

        collectEvent();

        var topDistance = 500;
        var showDistance = 1;
        var thisTop = $(window).scrollTop() + topDistance;
        // $('#goToTop').css('top' ,thisTop);
        if ($(window).scrollTop() < showDistance) {
          $('#goToTop').hide();
        }
        $(window).scroll(function () {
          thisTop = $(this).scrollTop() + topDistance;        //获取当前window向上滚动的距离
          if ($(this).scrollTop() > showDistance) {
            $('#goToTop').fadeIn();
          } else {
            $('#goToTop').fadeOut();
          }
        });

        // 给按钮绑定一个click事件，点击按钮时，返回顶部
        $('#goToTop').click(function () {
          $('html ,body').animate({scrollTop: 0}, 300);
          return false;
        });

        // setPermission();

      });

    </script>
</body>
</html>
